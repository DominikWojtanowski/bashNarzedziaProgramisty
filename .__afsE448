#!/bin/bash

RED="\e[0;31m"
GREEN="\e[0;32m"
YELLOW="\e[0;33m"
RESET="\e[0m"

format_time() {
    # TODO: zamień sekundy na MM:SS
    local time_sec=$1
    minutes=$((time_sec / 60))
    seconds=$((time_sec - minutes * 60))
    if [[ $minutes -le 9 ]]; then
        echo -n "0"
    fi
    echo -n $minutes":"
    if [[ $seconds -le 9 ]]; then
        echo -n "0"
    fi
    echo -n $seconds" "

}

progress_bar() {
    local current=$1 total=$2
    local tenPrecentOfTheTotalResult=$(awk -v total="$total" 'BEGIN {print total * 0.1}')
    currentProgressBar=$(awk -v current="$current" -v total="$total" 'BEGIN {print current / total}')
    precentProgressBar=$(awk -v currentProgressBar="$currentProgressBar" 'BEGIN {print currentProgressBar * 100}')
    local visualRepresentationOfDoneWork=$(awk -v precentProgressBar="$precentProgressBar" 'BEGIN {print int(precentProgressBar/10) }')
    local howMuchToFill=$((10 - visualRepresentationOfDoneWork))
    local howMuchToPrint=$((10 - howMuchToFill))

    echo -n "["
    echo -ne "$GREEN"
    for ((i = 0; i < howMuchToPrint; i++)); do
        echo -n "#"
    done
    echo -ne "$RESET"
    for ((i = 0; i < howMuchToFill; i++)); do
        echo -n " "
    done
    echo -n "] "
    echo -ne $precentProgressBar"%\033[K\r"
}

log_event() {
    # TODO: logowanie do pliku
    echo "log" >>~/laboratoria/lab4/logs.txt
}


run_pomodoro() {
    local work=${1:-25}
    local breaks=${2:-5}
    local cycles=${3:-4}

    local newWork=$work
    local newBreaks=0
    local time=0
    local breakTime=0

    while [[ $cycles -ne 0 ]]; do
        work=$1
        while [[ $work -ne 0 ]]; do
            work=$work-1
            time=$((time + 1))
            format_time $time
            progress_bar $((newWork - work)) $newWork
            sleep 1
        done
        breaks=$2
        newBreaks=$((newBreaks + 1))
        breakTime=0
        echo -ne "$RED"
        echo -ne "Przerwa: "$newBreaks"\033[K\r"
        while [[ $breaks -ne 0 ]]; do
            echo -ne "\033[K\rPrzerwa: "
            format_time $breakTime
            sleep 1
            breaks=$((breaks - 1))
            breakTime=$((breakTime + 1))

        done
        echo -ne "\rKoniec Przerwy!!\033[K\r"
        echo -ne "$RESET"
        sleep 1

        cycles=$cycles-1
    done
}

run_stoper() {
    local running=0
    local sec=0
    echo "1) Start"
    echo "2) Stop"
    echo "3) Reset"
    echo "4) Exit"

    while true; do
        read -rsn1 -t 0.1 choice
	

        case $choice in
        1)
		running=1  	
		;;
        2)
        	running=0
            ;;
        3)
	    sec=0
            ;;
        4)
            exit 0
            ;;
        esac
	echo $running
	if [ "$running" -eq 1 ]; then
		format_time $sec
		sleep 1
		sec=$(( sec + 1))
	fi

    done
	
}
test_variables() {
local re='^[0-9]+$'
if ! [[ $1 =~ $re ]]; then
	echo "error: not a number"
	exit 1
fi
if ! [[ $2 =~ $re ]]; then
	echo "error: not a number"
	exit 1
fi
if ! [[ $3 =~ $re ]]; then
	echo "error: not a number"
	exit 1
fi

}
case "$1" in
pomodoro)
    test_variables "$2" "$3" "$4"
    run_pomodoro "$2" "$3" "$4"
    ;;
stoper)
    run_stoper
    ;;
*)
    echo "Użycie:"
    echo "  $0 pomodoro [czas_pracy] [czas_przerwy] [cykle]"
    echo "  $0 stoper"
    ;;
esac
